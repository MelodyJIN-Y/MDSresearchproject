---
title: "R Notebook"
output: html_notebook
---
```{r}
library(Seurat)
library(dplyr)
library(SingleCellExperiment)
library(scater)
library(splatter)
library(reshape2)
library(pROC)
library(ggforce) 
library(limma)
library(tictoc)
library(foreach)
library(scales)

pbmc.data<- readRDS("pbmc_pooled_sex.Rds")
cm<- pbmc.data@assays$RNA@counts
table(pbmc.data$individual)

#subset_ind<- c("685_686", "689_690","691_692")
#cm<- pbmc.data[, pbmc.data$individual %in% subset_ind ]@assays$RNA@counts
cm<- pbmc.data[, pbmc.data$individual == "689_690"]@assays$RNA@counts
dim(cm) # 32738  3402 (1789+1613) $32738  4907

pbmc <- CreateSeuratObject(counts = cm,min.features = 500, min.cells = 5)


cm<-pbmc@assays$RNA@counts
ann.all<- readRDS("allpbmc.Rds")
numzero.genes <- rowSums(cm==0)
keep.genes <- numzero.genes < (ncol(cm)-10)
all.keep <- cm[keep.genes,]
ann.keep.all <- ann.all[keep.genes,]
cm.processed<- all.keep


# with one cell type from one individual
selected_cells <- colnames(cm.processed[,pbmc.data[,colnames(cm.processed)]$predicted.celltype.l1 =="CD4 T"])
cm.processed.r<- cm.processed[, match(selected_cells, colnames(cm.processed))]
metadata <- data.frame(cell_type = pbmc.data[row.names(cm.processed.r),colnames(cm.processed.r)]$predicted.celltype.l1,
                       ind = '689_690')

#sce <- SingleCellExperiment(assays = as.matrix(cm.processed.r),
#                            colData=metadata)

sce <- SingleCellExperiment(list(counts=as.matrix(cm.processed.r)),colData=metadata)


curr_params <- newSplatParams()
# params <- setParam(params, "group.prob", ct_prop)
curr_params <- splatEstimate(sce,params = curr_params)
```

```{r}
groups_lst<- list(c(0.01, 0.99),
                  c(0.05, 0.95),
                  c(0.1, 0.9),
                  c(0.2, 0.8),
                  c(0.3, 0.7),
                  c(0.4, 0.6),
                  c(0.5, 0.5)
                  )

perm.size = 4000
set.seed(12202)
seed.number.cp <- sample(x = 100:10000, size = length(groups_lst), replace = FALSE)
rep<- 1

for (cp in 1:length(groups_lst)){
  print(cp)
  setwd("~/Desktop/Data Science Research Project/MDSresearchproject/different_cp_stat/global_seed_7654")
  sim <- splatSimulate(curr_params, method = "groups", nGenes = 5000,
                       batchCells = 1000, dropout.type = "none", out.prob = 0, 
                       de.prob = c(0.02, 0.02),de.downProb = c(0, 0),
                       group.prob = groups_lst[[cp]],
                       seed = seed.number.cp[cp], 
                       de.facLoc = c(1.1,1.1),
                       de.facScale = c(0.5, 0.5),
                       verbose = FALSE
                       )
  
  sim <- logNormCounts(sim)
  sim <- runPCA(sim)
  plotPCA(sim, colour_by = "Group")+ggtitle("simulated CD4T cells")+ 
    theme(plot.title = element_text(size = 20, face = "bold"))
  
  
  numzero.genes <- rowSums(counts(sim)==0)
  keep.genes <- numzero.genes < (ncol(counts(sim))-groups_lst[[cp]][1]*1000)
  keep.genes <- setdiff(row.names(sim)[keep.genes],
                        intersect(row.names(sim)[sim@rowRanges@elementMetadata$DEFacGroup1 > 1], 
                                  row.names(sim)[sim@rowRanges@elementMetadata$DEFacGroup2 > 1]))
  sim<- sim[keep.genes, ]
  dim(sim)
  # check the logFC first
  obs_res<- computeObs(counts(sim), factor(sim$Group),statistic= "os.t")
  DE.g1<- row.names(sim)[sim@rowRanges@elementMetadata$DEFacGroup1 > 1]
  DE.g2<- row.names(sim)[sim@rowRanges@elementMetadata$DEFacGroup2 > 1]
  #summary(obs_res$summary.tb[DE.g1, "logFC.g1"])
  #summary(obs_res$summary.tb[DE.g2, "logFC.g2"])
  
  neglogFC.DEs <- c(intersect(DE.g1, row.names(obs_res$summary.tb)[obs_res$summary.tb$logFC.g1<0]),
                    intersect(DE.g2, row.names(obs_res$summary.tb)[obs_res$summary.tb$logFC.g2<0])
  )
  # remove true DEs with negative logFC
  if (length(neglogFC.DEs)>0) {
    sim<- sim[-match(neglogFC.DEs, row.names(sim)), ]
    print(paste("processed dimension:", dim(sim)))
    #obs_res<- computeObs(counts(sim), factor(sim$Group),statistic= "os.t")
    #DE.g1<- row.names(sim)[sim@rowRanges@elementMetadata$DEFacGroup1 > 1]
    #DE.g2<- row.names(sim)[sim@rowRanges@elementMetadata$DEFacGroup2 > 1]
    #summary(obs_res$summary.tb[DE.g1, "logFC.g1"])
    #summary(obs_res$summary.tb[DE.g2, "logFC.g2"])
  }
  
  
  cp<-paste(as.character(table(sim$Group)),collapse="_")
  os.t.res<- runComparison(sim, perm.size, statistic = "os.t")
  os.treatt.res<- runComparison(sim, perm.size, statistic = "os.treatt")
  lfc.p.res<- runComparison(sim, perm.size, statistic = "lfc.p")
  saveRDS(os.t.res, paste(cp, "os.t.res.Rds", collapse="."))
  saveRDS(os.treatt.res, paste(cp, "os.treatt.Rds", collapse="."))
  saveRDS(lfc.p.res, paste(cp, "lfc.p.Rds", collapse="."))
  #os.t.res<-readRDS(paste(cp, "os.t.res.Rds", collapse="."))
  #os.treatt.res<-readRDS(paste(cp, "os.treatt.Rds", collapse="."))
  #lfc.p.res<-readRDS(paste(cp, "lfc.p.Rds", collapse="."))
  stat.lst<- c("os.t","os.treatt", "lfc.p")
  res.lst<- list(os.t.res, os.treatt.res,lfc.p.res)

  if (exists("adj.df") == FALSE ){
    cols.n<- c("group","cell.type","num.cells", "test.name", "num.true.upreg","num.upreg",
              "TP", "precision", "sensitivity","overlap","TP.overlap","cutoff","perm.size",
              "seed.number","AUC","statistic")
    raw.p<- setNames(data.frame(matrix(ncol = length(cols.n), nrow = 0)), cols.n)
    adj.p<- setNames(data.frame(matrix(ncol = length(cols.n), nrow = 0)),cols.n)
  }
  for (a in 1:length(stat.lst)){
    auc.values <- plotComparison(sim, perm.size = perm.size, seed.n = seed.number.cp[cp], 
                                 result=res.lst[[a]])
    raw.df<-computeSummary3(res.lst[[a]]$obs.pval, res.lst[[a]]$perm.pval,
                            adj = "",
                            true.upreg = res.lst[[a]]$true.upreg, 
                            cell_num = as.vector(table(sim$Group)), 
                            main.describe = paste(as.character(table(sim$Group)),collapse="_"), 
                            seed.number=seed.number.cp[cp],perm.size=perm.size, 
                            auc.values=auc.values, statistic = stat.lst[[a]])
    
    adj.df<-computeSummary3(res.lst[[a]]$obs.pval.adj, res.lst[[a]]$perm.pval.adj,
                            adj = "adjusted",
                            true.upreg = res.lst[[a]]$true.upreg, 
                            cell_num=as.vector(table(sim$Group)), 
                            main.describe = paste(as.character(table(sim$Group)),collapse="_"), 
                            seed.number=seed.number.cp[cp],perm.size=perm.size,
                            auc.values=auc.values, statistic = stat.lst[[a]])
    raw.p<- rbind(raw.p, raw.df)
    adj.p<- rbind(adj.p, adj.df)
  }
  
}
saveRDS(raw.p, "raw.p.Rds")
saveRDS(adj.p, "adj.p.Rds")
```

```{r}
adj.p<-readRDS("~/Desktop/Data Science Research Project/MDSresearchproject/different_cp_stat/global_seed_12202/adj.p.Rds")
colnames(adj.p)
adj.p$group<- factor(adj.p$group)
adj.p[adj.p$statistic=="lfc.p"&adj.p$test.name=="limma","statistic"]<-"os.t"
adj.p[adj.p$TP==0,"precision"]<-0


adj.p$group <- factor(adj.p$group,levels = as.vector(unique(adj.p$group)))

adj.p$category <- paste(adj.p$test.name, adj.p$statistic)
adj.p$category<-factor(adj.p$category, levels = c("limma os.t", 
                                                  "permutation os.t",
                                                  "limma os.treatt",
                                                  "permutation os.treatt", "permutation lfc.p"))


library(ggplot2)
library(reshape2)
library(ggpubr)
library(ggExtra)
library(cowplot)
library(scales)

sensitivity.chart<-ggplot(data = adj.p, 
                          aes(x = group, y = sensitivity,fill = category))+
  geom_bar(width=0.65, stat="identity",color="black", position=position_dodge())+
  facet_wrap(~cell.type, nrow=2)+
  theme(axis.text.x = element_text(angle=90), legend.title=element_blank())+
  xlab("")+ylab("sensitivity")+ scale_y_continuous(limits=c(0.4, 1),oob = rescale_none)+scale_fill_manual(values=c('cyan','coral',"cyan3","darkgoldenrod1","brown2"))  #+scale_fill_brewer(palette="Set1")


precision.chart<-ggplot(data = adj.p, 
                        aes(x = group, y = precision,fill = category))+
  geom_bar(width=0.65, stat="identity",color="black", position=position_dodge())+
  facet_wrap(~cell.type, nrow=2)+
  theme(axis.text.x = element_text(angle=90), legend.title=element_blank())+
  xlab("")+ylab("precision")+ scale_y_continuous(limits=c(0.7, 1),oob = rescale_none)+
  scale_fill_manual(values=c('cyan','coral',"cyan3","darkgoldenrod1","brown2")) 
  #scale_fill_brewer(palette="Set1")
#+scale_fill_manual(values=c('#00BA42','orange',"pink")) #+ggtitle("adjusted pvalues")#
#ggsave("simulation_result_num_upreg_adj.pdf", width = 8, height=6)

numcells.barchart<- ggplot(data = adj.p, 
                           aes(x = group, y = num.cells, fill =cell.type))+
  scale_y_continuous(position = "right")+
  geom_bar(stat="identity", position=position_dodge())+
  theme(axis.text.x = element_text(angle=90), legend.title=element_blank())+
  xlab("")+ylab("number of cells")+
  geom_text(aes(label=num.cells), vjust=1.6, color="black",
            position = position_dodge(0.9), size=3.5)

numcells.barchart<- ggplot(data = adj.p, 
                           aes(x = group, y = num.cells))+
  scale_y_continuous(position = "right")+
  geom_bar(stat="identity", fill="cornsilk3",position=position_dodge())+facet_wrap(~cell.type, nrow=2)+
  theme(axis.text.x = element_text(angle=90), 
        axis.text.y = element_blank(),legend.title=element_blank(), 
        axis.ticks = element_line(size = 0), 
        panel.grid=element_line(size = 0),
        panel.background = element_rect(fill = "white"))+
  xlab("")+ylab("number of cells")+
  geom_text(aes(label=num.cells), vjust=0, color="black",
            position = position_dodge(0.9), size=2)


line.chart<- ggplot(data = adj.p, aes(x = group, y = sensitivity,colour = statistic,
                                      group =statistic))+
  geom_line()+
  #geom_bar(aes(x=group, y=num.cells/1000),stat="identity", color="black", position=position_dodge())+
  geom_point(aes(color = statistic))+
  facet_grid(cell.type~test.name)+#ggtitle("adjusted pvalues")+
  theme(axis.text.x = element_text(angle=90), legend.title=element_blank())+
  xlab("")+ylab("sensitivity")

ggarrange(precision.chart, sensitivity.chart, heights = c(3,3), ncol = 2,  nrow = 1,
          widths=c(2, 2),legend="top", common.legend = T)

ggarrange(precision.chart, numcells.barchart, heights = c(3,3), ncol = 2,  nrow = 1,
          widths=c(5, 2),legend="top", common.legend = T)
ggsave("barchart_simulation_result_pres.pdf", width = 8, height=6)
```
repeted version II of the second code chunk
calculate different stat at one single perm run 
```{r}

groups_lst<- list(c(0.01, 0.99),
                  c(0.05, 0.95),
                  c(0.1, 0.9),
                  c(0.2, 0.8),
                  c(0.3, 0.7),
                  c(0.4, 0.6),
                  c(0.5, 0.5)
                  )
#groups_lst<- list(c(0.01, 0.99), c(0.1, 0.9)
 #                 )
#perm.size = 4000
set.seed(56892)
rep.times<-20
seed.number.cp <- sample(x = 100:10000, size = rep.times, replace = FALSE)

# rm(adj.p, adj.df, raw.p, raw.df)
tic.clearlog()
tic(paste(rep.times, "repeated rounds total time"))
for (rep in 1: rep.times){
  set.seed(seed.number.cp[rep])
  rep.seed <- sample(x = seed.number.cp[rep]:seed.number.cp[rep]+8900, 
                         size = length(groups_lst), replace = FALSE)
  print(paste("repeated round", rep, "started"))
  tic(paste("repeated round", rep, "time"))
  for (cp in 1:length(groups_lst)){
   
    #rep.seed[cp]
    #setwd("~/Desktop/Data Science Research Project/MDSresearchproject/different_cp_stat/global_seed_7654")
    sim <- splatSimulate(curr_params, method = "groups", nGenes = 5000,
                         batchCells = 1000, dropout.type = "none", out.prob = 0, 
                         de.prob = c(0.02, 0.02),de.downProb = c(0, 0),
                         group.prob = groups_lst[[cp]],
                         #seed = seed.number.cp[cp], 
                         seed = rep.seed[cp], 
                         de.facLoc = c(1.1, 1.1),
                         de.facScale = c(0.5, 0.5),
                         verbose = FALSE
                         )
    
    #sim <- logNormCounts(sim)
    #sim <- runPCA(sim)
    #plotPCA(sim, colour_by = "Group")+ggtitle("simulated CD4T cells")+ 
    #  theme(plot.title = element_text(size = 20, face = "bold"))
    
    
    ############################################################################
    # QC 
    # remove lowly expressed genes 
    numzero.genes <- rowSums(counts(sim)==0)
    keep.genes <- numzero.genes < (ncol(counts(sim))-min(groups_lst[[cp]][1]*1000, 100))
    keep.genes <- setdiff(row.names(sim)[keep.genes],
                          intersect(row.names(sim)[sim@rowRanges@elementMetadata$DEFacGroup1 > 1], 
                                    row.names(sim)[sim@rowRanges@elementMetadata$DEFacGroup2 > 1]))
    sim<- sim[keep.genes, ]
    
    # check the logFC for each gene 
    obs_res<- computeObs(counts(sim), factor(sim$Group),statistic= "os.t")
    DE.g1<- row.names(sim)[sim@rowRanges@elementMetadata$DEFacGroup1 > 1]
    DE.g2<- row.names(sim)[sim@rowRanges@elementMetadata$DEFacGroup2 > 1]
    #summary(obs_res$summary.tb[DE.g1, "logFC.g1"])
    #summary(obs_res$summary.tb[DE.g2, "logFC.g2"])
    
    neglogFC.DEs <- c(intersect(DE.g1, row.names(obs_res$summary.tb)[obs_res$summary.tb$logFC.g1<0]),
                      intersect(DE.g2, row.names(obs_res$summary.tb)[obs_res$summary.tb$logFC.g2<0])
    )
    # remove true DEs with negative logFC
    if (length(neglogFC.DEs)>0) {
      sim<- sim[-match(neglogFC.DEs, row.names(sim)), ]
    }
    message(paste("simulated data dimension:",paste(as.character(dim(sim)), collapse = ", ")))
    
    # set the identifier for the plots 
    prefix<-paste("s",rep.seed[cp], paste(as.character(table(sim$Group)),collapse="_"), sep="_")
    
    ############################################################################
    # run permutation for all stats
    n.cores=parallel::detectCores()-8
    if (cp == 1){
      perm.size = 8000
    }else{
      perm.size = 4000
    }
    perm.array.lst<- pPerm.stat(counts(sim), sim$Group, perm.size=perm.size, n.cores=n.cores)
    
    # generate perm & observation p-values for each stat 
    os.t.res<- runComparison.stat(sim, perm.size, statistic = "os.t", 
                                  sim_perm_arrays = perm.array.lst$os.t.stat, 
                                  n.cores = n.cores)
    os.modt.res<- runComparison.stat(sim, perm.size, statistic = "os.modt", 
                                  sim_perm_arrays = perm.array.lst$os.modt.stat, 
                                  n.cores = n.cores)
    os.treatt.res<- runComparison.stat(sim, perm.size, statistic = "os.treatt", 
                                  sim_perm_arrays = perm.array.lst$os.treatt.stat, 
                                  n.cores = n.cores)
    ts.modt.res<- runComparison.stat(sim, perm.size, statistic = "ts.modt", 
                                  sim_perm_arrays = perm.array.lst$ts.modt.stat,
                                  n.cores = n.cores)
    lfc.p.res<-runComparison.stat(sim, perm.size, statistic = "lfc.p", 
                                  sim_perm_arrays = perm.array.lst$lfc.p.stat, 
                                  n.cores = n.cores)
    #os.t.res.1<- runComparison(sim, perm.size, statistic = "os.t", n.cores = n.cores)
    # save the result for each stat 
    saveRDS(os.t.res, paste(prefix, "os.t.Rds", sep="."))
    saveRDS(os.treatt.res, paste(prefix, "os.treatt.Rds", sep="."))
    saveRDS(lfc.p.res, paste(prefix, "lfc.p.Rds", sep="."))
    saveRDS(ts.modt.res, paste(prefix, "ts.modt.Rds", sep="."))
    saveRDS(os.modt.res, paste(prefix, "os.modt.Rds", sep="."))
    #os.t.res<-readRDS(paste(cp, "os.t.res.Rds", collapse="."))
    #os.treatt.res<-readRDS(paste(cp, "os.treatt.Rds", collapse="."))
    #lfc.p.res<-readRDS(paste(cp, "lfc.p.Rds", collapse="."))
    
    ############################################################################
    # creat the result table 
    stat.lst<- c("os.t","os.treatt", "lfc.p","ts.modt", "os.modt")
    res.lst<- list(os.t.res, os.treatt.res,lfc.p.res, ts.modt.res,os.modt.res)
    if (exists("adj.df") == FALSE ){
      cols.n<- c("group","cell.type","num.cells", "test.name", "num.true.upreg","num.upreg",
                 "TP", "precision", "sensitivity","F1","overlap","TP.overlap","cutoff","perm.size",
                 "seed.number","AUC","statistic")
      raw.p<- setNames(data.frame(matrix(ncol = length(cols.n), nrow = 0)), cols.n)
      adj.p<- setNames(data.frame(matrix(ncol = length(cols.n), nrow = 0)),cols.n)
    }
    for (a in 1:length(stat.lst)){
      auc.values <- plotComparison(sim, perm.size = perm.size, seed.n = rep.seed[cp], 
                                   result=res.lst[[a]])
      if (stat.lst[a] == "ts.modt"){
        raw.df<-computeSummary3simple(res.lst[[a]]$obs.pval, res.lst[[a]]$perm.pval,
                              adj = "",
                              true.upreg = res.lst[[a]]$true.upreg, 
                              cell_num = as.vector(table(sim$Group)), 
                              main.describe = paste(as.character(table(sim$Group)),collapse="_"), 
                              seed.number=rep.seed[cp],perm.size=perm.size, 
                              logFC.df=obs_res$summary.tb[, c(1, 2)], 
                              auc.values=auc.values, statistic = stat.lst[[a]])
      
      adj.df<-computeSummary3simple(res.lst[[a]]$obs.pval.adj, res.lst[[a]]$perm.pval.adj,
                              adj = "adjusted",
                              true.upreg = res.lst[[a]]$true.upreg, 
                              cell_num=as.vector(table(sim$Group)), 
                              main.describe = paste(as.character(table(sim$Group)),collapse="_"), 
                              seed.number=rep.seed[cp],perm.size=perm.size,
                              logFC.df=obs_res$summary.tb[, c(1, 2)], 
                              auc.values=auc.values, statistic = stat.lst[[a]])
      }else{raw.df<-computeSummary3simple(res.lst[[a]]$obs.pval, res.lst[[a]]$perm.pval,
                              adj = "",
                              true.upreg = res.lst[[a]]$true.upreg, 
                              cell_num = as.vector(table(sim$Group)), 
                              main.describe = paste(as.character(table(sim$Group)),collapse="_"), 
                              seed.number=rep.seed[cp],perm.size=perm.size, 
                              auc.values=auc.values, statistic = stat.lst[[a]])
      
      adj.df<-computeSummary3simple(res.lst[[a]]$obs.pval.adj, res.lst[[a]]$perm.pval.adj,
                              adj = "adjusted",
                              true.upreg = res.lst[[a]]$true.upreg, 
                              cell_num=as.vector(table(sim$Group)), 
                              main.describe = paste(as.character(table(sim$Group)),collapse="_"), 
                              seed.number=rep.seed[cp],perm.size=perm.size,
                              auc.values=auc.values, statistic = stat.lst[[a]])}
      
      
      raw.p<- rbind(raw.p, raw.df)
      adj.p<- rbind(adj.p, adj.df)
    }
    
  }
  print(paste("round", rep,"finished"))
  toc(log = T)
}
toc(log = T)

saveRDS(adj.p, "adj.p.Rds")
```



```{r}
adj.p$group<- factor(adj.p$group)
adj.p[adj.p$statistic=="lfc.p"&adj.p$test.name=="limma","statistic"]<-"os.t"

adj.p[adj.p$TP==0,"precision"]<-0
adj.p[adj.p$TP==0,"sensitivity"]<-0
adj.p[adj.p$TP==0,"F1"]<-0

adj.p$group <- factor(adj.p$group,levels = as.vector(unique(adj.p$group)))

adj.p$category <- paste(adj.p$test.name, adj.p$statistic)
adj.p$category<-factor(adj.p$category, levels = c("limma os.t", 
                                                  "permutation os.t",
                                                  "limma os.treatt",
                                                  "permutation os.treatt",
                                                  "limma os.modt", 
                                                  "permutation os.modt",
                                                  "limma ts.modt", 
                                                  "permutation ts.modt",
                                                  "permutation lfc.p"))
gr<- unlist(groups_lst)*100
cp.ft<-as.vector(rep(tapply(gr, as.character(gl(length(gr), 2, length(gr))),   
                                FUN= paste, collapse='_'), 1))

adj.p$cp<- rep(cp.ft,times=15,each = 4*5)

adj.p$cp<-factor(adj.p$cp, levels = c("1_99","5_95","10_90","20_80","30_70","40_60","50_50"))
sensitivity<-ggplot(data = adj.p, 
       aes(x = factor(category), y = sensitivity,fill = category))+
  
  #geom_bar(width=0.65, stat="identity",color="black", position=position_dodge())+
  #geom_jitter(position=position_jitter(0.4))+
  #geom_point(position=position_jitterdodge(0.6))+
  #geom_dotplot(binaxis = "y", stackgroups = TRUE,  method = "histodot")+
  #geom_point(position=position_jitterdodge(dodge.width=0.1)) +
  geom_boxplot(size=0.2, position=position_dodge(1))+
  geom_point(position=position_jitterdodge(jitter.width=3, jitter.height=0), 
             size=0.4, color = "black", alpha=0.9)+
  
  facet_grid(cell.type~cp, scales='free_x', space='free_x')+
  theme(axis.text.x = element_text(angle=90), 
        legend.title=element_blank(),
        axis.ticks.x=element_blank(), 
        axis.text.x.bottom =element_blank(), 
        axis.title.x=element_blank(),
        panel.spacing = unit(0.5, "lines"), 
        legend.position="top", #legend.text=element_text(),
        #legend.spacing.x = unit(0.6, 'cm'),
        legend.text=element_text(margin=margin(r=0.6,unit="cm"),size=18))+
  guides(fill = guide_legend(ncol = 9))+
  #xlab("")+
  ylab("sensitivity")+ 
  scale_y_continuous(limits=c(0, 1), oob = rescale_none)+
  scale_fill_manual(values=c('lightsteelblue2','navajowhite2',
                              "steelblue2","darkgoldenrod1",
                              "royalblue1","coral","blue4","tomato3",
                              "green4"))
ggsave("sensitivity.pdf", width = 18, height=6)
precision<-ggplot(data = adj.p, 
       aes(x = factor(category), y = precision,fill = category))+
  geom_boxplot(size=0.2, position=position_dodge(1))+
  geom_point(position=position_jitterdodge(jitter.width=3, jitter.height=0), 
             size=0.4, color = "black", alpha=0.9)+
  
  facet_grid(cell.type~cp, scales='free_x', space='free_x')+
   theme(axis.text.x = element_text(angle=90), 
        legend.title=element_blank(),
        axis.ticks.x=element_blank(), 
        axis.text.x.bottom =element_blank(), 
        axis.title.x=element_blank(),
        panel.spacing = unit(0.5, "lines"), 
        legend.position="top", 
        legend.text=element_text(margin=margin(r=0.6,unit="cm"),size=18))+
  guides(fill = guide_legend(ncol = 9))+
  #xlab("")+
  ylab("precision")+ 
  scale_y_continuous(limits=c(0, 1), oob = rescale_none)+
  scale_fill_manual(values=c('lightsteelblue2','navajowhite2',
                              "steelblue2","darkgoldenrod1",
                              "royalblue1","coral","blue4","tomato3",
                              "green4"))
ggsave("precision.pdf", width = 18, height=6)

ggplot(data = adj.p, 
       aes(x = factor(category), y = F1,fill = category))+
  geom_boxplot(size=0.2, position=position_dodge(1))+
  geom_point(position=position_jitterdodge(jitter.width=3, jitter.height=0), 
             size=0.4, color = "black", alpha=0.9)+
  
  facet_grid(cell.type~cp, scales='free_x', space='free_x')+
  theme(axis.text.x = element_text(angle=90), 
        legend.title=element_blank(),
        axis.ticks.x=element_blank(), 
        axis.text.x.bottom =element_blank(), 
        axis.title.x=element_blank(),
        panel.spacing = unit(0.5, "lines"), 
        legend.position="top", legend.text=element_text(margin=margin(r=0.5,unit="cm"),size=14))+
  guides(fill = guide_legend(ncol = 9))+
  #xlab("")+
  ylab("F1 score")+ 
  scale_y_continuous(limits=c(0, 1), oob = rescale_none)+
  scale_fill_manual(values=c('lightsteelblue2','navajowhite2',
                              "steelblue2","darkgoldenrod1",
                              "royalblue1","coral","blue4","tomato3",
                              "green4"))
ggsave("F1.pdf", width = 18, height=6)


ggarrange(precision, sensitivity, heights = c(3,3), ncol = 1,  nrow = 2,
          legend="top", common.legend = T)
ggsave("simulation_result.pdf", width = 23, height=12)

```
(code chunk A) repeted version I of the second code chunk
```{r}
groups_lst<- list(c(0.01, 0.99),
                  c(0.05, 0.95),
                  c(0.1, 0.9),
                  c(0.2, 0.8),
                  c(0.3, 0.7),
                  c(0.4, 0.6),
                  c(0.5, 0.5)
                  )

perm.size = 4000
set.seed(12202)
rep.times<-5
seed.number.cp <- sample(x = 100:10000, size = rep.times, replace = FALSE)
#for (rep in 1: rep.times){
# set.seed(seed.number.cp[rep])
#  rep.seed <- sample(x = seed.number.cp[rep]:seed.number.cp[rep]+8900, 
#                          size = length(groups_lst), replace = FALSE)
##  for (cp in 1:length(groups_lst)){
#    print(rep.seed[cp])
#  }
#  print(paste("round", rep,"finished"))
  
#}
# rm(adj.p, adj.df, raw.p, raw.df)
for (rep in 1: rep.times){
  set.seed(seed.number.cp[rep])
  rep.seed <- sample(x = seed.number.cp[rep]:seed.number.cp[rep]+8900, 
                         size = length(groups_lst), replace = FALSE)
  print(paste("round", rep,"started"))
  for (cp in 1:length(groups_lst)){
    #rep.seed[cp]
    #setwd("~/Desktop/Data Science Research Project/MDSresearchproject/different_cp_stat/global_seed_7654")
    sim <- splatSimulate(curr_params, method = "groups", nGenes = 5000,
                         batchCells = 1000, dropout.type = "none", out.prob = 0, 
                         de.prob = c(0.02, 0.02),de.downProb = c(0, 0),
                         group.prob = groups_lst[[cp]],
                         #seed = seed.number.cp[cp], 
                         seed = rep.seed[cp], 
                         de.facLoc = c(1.1,1.1),
                         de.facScale = c(0.5, 0.5),
                         verbose = FALSE
    )
    
    #sim <- logNormCounts(sim)
    #sim <- runPCA(sim)
    #plotPCA(sim, colour_by = "Group")+ggtitle("simulated CD4T cells")+ 
    #  theme(plot.title = element_text(size = 20, face = "bold"))
    
    # number of zeros each gene have 
    numzero.genes <- rowSums(counts(sim)==0)
    keep.genes <- numzero.genes < (ncol(counts(sim))-min(groups_lst[[cp]][1]*1000, 100))
    keep.genes <- setdiff(row.names(sim)[keep.genes],
                          intersect(row.names(sim)[sim@rowRanges@elementMetadata$DEFacGroup1 > 1], 
                                    row.names(sim)[sim@rowRanges@elementMetadata$DEFacGroup2 > 1]))
    sim<- sim[keep.genes, ]
    #print(dim(sim))
    
    prefix<-paste("s",rep.seed[cp], paste(as.character(table(sim$Group)),collapse="_"), sep="_")
    
    n.cores=parallel::detectCores()-8
    os.t.res<- runComparison(sim, perm.size, statistic = "os.t", n.cores = n.cores)
    os.treatt.res<- runComparison(sim, perm.size, statistic = "os.treatt", n.cores = n.cores)
    lfc.p.res<- runComparison(sim, perm.size, statistic = "lfc.p", n.cores = n.cores)
    os.modt.res<- runComparison(sim, perm.size, statistic = "os.modt", n.cores = n.cores)
    ts.modt.res<- runComparison(sim, perm.size, statistic = "ts.modt", n.cores = n.cores)
    saveRDS(os.t.res, paste(prefix, "os.t.res.Rds", sep="."))
    saveRDS(os.treatt.res, paste(prefix, "os.treatt.Rds", sep="."))
    saveRDS(lfc.p.res, paste(prefix, "lfc.p.Rds", sep="."))
    saveRDS(ts.modt.res, paste(prefix, "ts.modt.Rds", sep="."))
    #os.t.res<-readRDS(paste(cp, "os.t.res.Rds", collapse="."))
    #os.treatt.res<-readRDS(paste(cp, "os.treatt.Rds", collapse="."))
    #lfc.p.res<-readRDS(paste(cp, "lfc.p.Rds", collapse="."))
    stat.lst<- c("os.t","os.treatt", "lfc.p","ts.modt")
    res.lst<- list(os.t.res, os.treatt.res,lfc.p.res, ts.modt.res)
    
    if (exists("adj.df") == FALSE ){
      cols.n<- c("group","cell.type","num.cells", "test.name", "num.true.upreg","num.upreg",
                 "TP", "precision", "sensitivity","overlap","TP.overlap","cutoff","perm.size",
                 "seed.number","AUC","statistic")
      raw.p<- setNames(data.frame(matrix(ncol = length(cols.n), nrow = 0)), cols.n)
      adj.p<- setNames(data.frame(matrix(ncol = length(cols.n), nrow = 0)),cols.n)
    }
    for (a in 1:length(stat.lst)){
      auc.values <- plotComparison(sim, perm.size = perm.size, seed.n = rep.seed[cp], 
                                   result=res.lst[[a]])
      raw.df<-computeSummary3(res.lst[[a]]$obs.pval, res.lst[[a]]$perm.pval,
                              adj = "",
                              true.upreg = res.lst[[a]]$true.upreg, 
                              cell_num = as.vector(table(sim$Group)), 
                              main.describe = paste(as.character(table(sim$Group)),collapse="_"), 
                              seed.number=rep.seed[cp],perm.size=perm.size, 
                              auc.values=auc.values, statistic = stat.lst[[a]])
      
      adj.df<-computeSummary3(res.lst[[a]]$obs.pval.adj, res.lst[[a]]$perm.pval.adj,
                              adj = "adjusted",
                              true.upreg = res.lst[[a]]$true.upreg, 
                              cell_num=as.vector(table(sim$Group)), 
                              main.describe = paste(as.character(table(sim$Group)),collapse="_"), 
                              seed.number=rep.seed[cp],perm.size=perm.size,
                              auc.values=auc.values, statistic = stat.lst[[a]])
      raw.p<- rbind(raw.p, raw.df)
      adj.p<- rbind(adj.p, adj.df)
    }
    
  }
  print(paste("round", rep,"finished"))
}
```


```{r}
for (cp in 1:length(groups_lst)){
    #rep.seed[cp]
    #setwd("~/Desktop/Data Science Research Project/MDSresearchproject/different_cp_stat/global_seed_7654")
    sim <- splatSimulate(curr_params, method = "groups", nGenes = 5000,
                         batchCells = 1000, dropout.type = "none", out.prob = 0, 
                         de.prob = c(0.02, 0.02),de.downProb = c(0, 0),
                         group.prob = groups_lst[[cp]],
                         #seed = seed.number.cp[cp], 
                         seed = rep.seed[cp], 
                         de.facLoc = c(1.1, 1.1),
                         de.facScale = c(0.5, 0.5),
                         verbose = FALSE
                         )
    
    sim <- logNormCounts(sim)
    sim <- runPCA(sim)
     prefix<-paste("s",rep.seed[cp], paste(as.character(table(sim$Group)),collapse="_"), sep="_")
     pdf(paste(prefix, "pdf", sep="."))
    plot(plotPCA(sim, colour_by = "Group")+ggtitle("simulated CD4T cells")+ 
      theme(plot.title = element_text(size = 20, face = "bold")))
    dev.off()
}
```

